datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL") // Crucial for migrations on serverless
}

generator client {
  provider = "prisma-client-js"
}

// Required for Lucia's PrismaAdapter
model Session {
  id        String   @id @default(cuid()) // cuid() is recommended by Lucia for better performance; fallback to uuid() if preferred
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("session")
}

model User {
  id            String    @id @default(uuid())
  fullname      String    @unique
  email         String?   @unique
  password_hash String?   // We'll store hashed passwords here
  role          Role      @default(staff)
  hotel_id      String?
  hotel         Hotel?    @relation("HotelUsers", fields: [hotel_id], references: [id])
  staff_profile Staff?
  is_approved   Boolean   @default(false)
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  owned_hotels         Hotel[]       @relation("HotelOwner")
  folios               Folio[]
  transactions         Transaction[]
  approvedTransactions Transaction[] @relation("approvedBy")
  sessions             Session[]     // Added for Lucia session management
}

model Hotel {
  id                   String  @id @default(uuid())
  name                 String
  address              String?
  room_count           Int
  subscription_tier    SubscriptionTier?
  subscription_status  SubscriptionStatus? @default(trial)
  subscription_start   DateTime?
  subscription_end     DateTime?
  owner_id             String? @unique
  owner                User?   @relation("HotelOwner", fields: [owner_id], references: [id])

  rooms   Room[]
  staff   Staff[]
  users   User[]  @relation("HotelUsers")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model Staff {
  id        String   @id @default(uuid())
  user_id   String?  @unique
  user      User?    @relation(fields: [user_id], references: [id], onDelete: SetNull)
  hotel_id  String
  hotel     Hotel    @relation(fields: [hotel_id], references: [id], onDelete: Cascade)
  fullname  String
  email     String   @unique
  phone     String?
  role      Role
  status    StaffStatus @default(ACTIVE)
  hire_date DateTime
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

////////////////////
// ROOMS & BOOKINGS
////////////////////
model Room {
  id               String    @id @default(uuid())
  hotel_id         String
  hotel            Hotel     @relation(fields: [hotel_id], references: [id], onDelete: Cascade)
  room_number      String
  type             RoomType?
  status           RoomStatus?
  rate_per_hour    Float?
  rate_per_night   Float?
  last_occupied_at DateTime?
  bookings         Booking[]
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  @@unique([hotel_id, room_number])
}

model Booking {
  id          String        @id @default(uuid())
  room_id     String
  room        Room          @relation(fields: [room_id], references: [id], onDelete: Cascade)
  hotel_id    String
  guest_name  String
  guest_email String
  check_in    DateTime
  check_out   DateTime
  total_price Float
  status      BookingStatus
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
}

////////////////////
// FOLIOS & TRANSACTIONS
////////////////////
model Folio {
  id              String        @id @default(uuid())
  hotel_id        String
  room_id         String
  guest_name      String?
  guest_phone     String?
  check_in        DateTime?
  check_out       DateTime?
  duration_minutes Int?
  total_amount    Float?
  payment_status  PaymentStatus?
  ota_source      String?
  staff_id        String
  staff           User          @relation(fields: [staff_id], references: [id])
  transactions    Transaction[]
  created_at      DateTime      @default(now())
  updated_at      DateTime      @updatedAt
}

model Transaction {
  id                String   @id @default(uuid())
  folio_id          String
  folio             Folio    @relation(fields: [folio_id], references: [id], onDelete: Cascade)
  amount            Float
  type              TransactionType
  status            TransactionStatus
  staff_id          String
  staff             User     @relation(fields: [staff_id], references: [id])
  approval_required Boolean?
  approved_by_id    String?
  approved_by       User?    @relation("approvedBy", fields: [approved_by_id], references: [id])
  transaction_ref   String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
}

////////////////////
// ENUMS
////////////////////
enum Role {
  staff
  manager
  owner
  admin
  super_admin
  frontdesk
  cleaner
}

enum StaffStatus {
  ACTIVE
  INACTIVE
}

enum SubscriptionTier {
  standalone
  add_on
}

enum SubscriptionStatus {
  active
  trial
  expired
}

enum RoomType {
  standard
  deluxe
  suite
  SINGLE
  DOUBLE
  SUITE
}

enum RoomStatus {
  available
  occupied
  cleaning
  maintenance
  AVAILABLE
  OCCUPIED
  MAINTENANCE
}

enum PaymentStatus {
  paid
  partial
  unpaid
}

enum TransactionType {
  cash
  opay
  palmpay
  bank
}

enum TransactionStatus {
  success
  pending
  failed
  voided
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
}